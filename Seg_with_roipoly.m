%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Segmentation with roipoly
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%[BW_1_sys,x1s,y1s] = roipoly(img1_sys_S);
x1s = [49.0354691075515 50.1910755148742 51.8089244851259 54.1201372997712 57.8180778032037 61.0537757437071 64.2894736842106 67.7562929061785 73.0720823798627 76.3077803203662 80.2368421052632 83.7036613272312 86.0148741418765 87.4016018306636 89.0194508009154 89.7128146453090 90.1750572082380 89.4816933638444 88.0949656750572 86.0148741418765 84.3970251716248 81.6235697940504 79.7745995423341 75.8455377574371 72.3787185354692 69.1430205949657 65.9073226544623 61.5160183066362 58.2803203661328 54.8135011441648 53.1956521739131 52.0400457665904 50.6533180778033 49.0354691075515];
y1s = [59.3203661327231 54.0045766590389 50.7688787185355 48.4576659038901 46.3775743707094 45.2219679633867 44.0663615560641 43.3729977116705 42.2173913043478 42.2173913043478 42.6796338672769 43.3729977116705 45.2219679633867 48.6887871853547 51.2311212814645 54.0045766590389 57.2402745995423 60.9382151029748 64.6361556064073 67.6407322654462 69.4897025171625 71.3386727688787 72.4942791762014 73.6498855835240 73.6498855835240 73.8810068649886 73.8810068649886 72.7254004576659 71.3386727688787 69.2585812356979 67.4096109839817 64.8672768878719 62.5560640732265 59.3203661327231];
BW_1_sys = roipoly(img1_sys_S,x1s,y1s);

%[BW_2_sys,x2s,y2s] = roipoly(img2_sys_S);
x2s = [51.1155606407323 51.3466819221968 53.4267734553776 56.4313501144165 59.8981693363845 63.5961098398170 67.7562929061785 72.6098398169337 78.3878718535470 82.3169336384440 86.9393592677346 89.4816933638444 91.5617848970252 92.2551487414188 91.0995423340961 87.6327231121282 82.7791762013730 79.3123569794051 74.4588100686499 67.5251716247140 61.9782608695653 56.6624713958810 54.5823798627003 52.7334096109840 52.0400457665904 51.1155606407323];
y2s = [60.0137299771167 55.6224256292906 51.9244851258581 49.1510297482838 46.6086956521739 44.0663615560641 41.7551487414188 40.3684210526316 41.5240274599542 44.0663615560641 47.3020594965675 51.9244851258581 55.8535469107551 60.7070938215103 64.4050343249428 68.7963386727689 71.8009153318078 73.8810068649886 75.9610983981693 77.1167048054920 75.9610983981693 73.1876430205950 69.4897025171625 66.2540045766590 62.0938215102975 60.0137299771167];
BW_2_sys = roipoly(img2_sys_S,x2s,y2s);

%[BW_3_sys,x3s,y3s] = roipoly(img3_sys_S);
x3s = [50.8844393592678 52.5022883295195 55.0446224256293 58.2803203661328 61.5160183066362 66.3695652173913 70.2986270022884 74.2276887871854 78.3878718535470 81.6235697940504 84.6281464530893 86.9393592677346 88.0949656750572 88.5572082379863 88.3260869565218 86.7082379862701 83.9347826086957 79.7745995423341 77.0011441647598 72.8409610983982 67.9874141876431 63.3649885583524 58.7425629290618 55.0446224256293 53.1956521739131 51.8089244851259 50.8844393592678 50.8844393592678];
y3s = [54.2356979405034 49.3821510297483 46.3775743707094 43.1418764302059 41.2929061784897 40.3684210526316 40.1372997711670 40.1372997711670 41.5240274599542 43.1418764302059 44.9908466819222 48.4576659038901 52.3867276887872 56.7780320366133 60.0137299771167 64.4050343249428 68.1029748283753 70.4141876430206 72.2631578947368 74.3432494279176 74.5743707093821 74.8054919908467 73.1876430205950 70.8764302059497 67.4096109839817 63.0183066361556 59.3203661327231 54.2356979405034];
BW_3_sys = roipoly(img3_sys_S,x3s,y3s);

%[BW_4_sys,x4s,y4s] = roipoly(img4_sys_S);
x4s = [49.2665903890160 49.4977116704806 50.6533180778033 52.5022883295195 55.9691075514874 62.4405034324943 67.5251716247140 72.6098398169337 77.0011441647598 83.7036613272312 86.2459954233410 87.6327231121282 88.5572082379863 88.0949656750572 86.2459954233410 83.9347826086957 81.1613272311213 75.3832951945080 68.9118993135012 62.6716247139588 58.0491990846682 53.8890160183067 51.1155606407323 50.6533180778033 49.2665903890160];
y4s = [57.2402745995423 52.3867276887872 48.6887871853547 45.4530892448513 41.2929061784897 38.2883295194508 37.8260869565217 38.7505720823799 40.1372997711670 42.9107551487414 46.6086956521739 51.2311212814645 54.6979405034325 59.0892448512586 63.0183066361556 66.4851258581236 69.2585812356979 72.0320366132723 73.8810068649886 74.5743707093821 72.9565217391304 69.4897025171625 64.1739130434783 60.2448512585812 57.2402745995423];
BW_4_sys = roipoly(img4_sys_S,x4s,y4s);

%[BW_5_sys,x5s,y5s] = roipoly(img5_sys_S);
x5s = [48.5732265446225 48.8043478260870 50.1910755148742 51.5778032036614 55.5068649885584 60.1292906178490 64.5205949656751 68.4496567505721 73.5343249427918 79.5434782608696 81.8546910755149 83.9347826086957 83.9347826086957 82.7791762013730 80.6990846681923 76.5389016018307 72.6098398169337 68.9118993135012 62.4405034324943 58.2803203661328 53.6578947368421 51.1155606407323 48.5732265446225];
y5s = [55.8535469107551 49.6132723112128 44.7597254004577 41.5240274599542 38.9816933638444 38.0572082379863 38.0572082379863 38.2883295194508 39.2128146453089 41.0617848970252 45.2219679633867 49.8443935926773 55.3913043478261 61.4004576659039 64.6361556064073 66.9473684210526 69.0274599542334 70.6453089244851 72.0320366132723 70.6453089244851 66.9473684210526 60.4759725400458 55.8535469107551];
BW_5_sys = roipoly(img5_sys_S,x5s,y5s);

%[BW_1_dias,x1d,y1d] = roipoly(img1_dias_S);
x1d = [54.5823798627003 53.4267734553776 53.8890160183067 56.4313501144165 60.3604118993135 64.0583524027460 68.4496567505721 72.3787185354692 75.8455377574371 77.0011441647598 75.8455377574371 73.5343249427918 70.7608695652174 66.3695652173913 61.0537757437071 56.6624713958810 54.5823798627003];
y1d = [63.9427917620137 60.4759725400458 55.6224256292906 52.8489702517162 51.6933638443936 51.4622425629291 51.9244851258581 53.5423340961098 56.3157894736842 60.4759725400458 64.6361556064073 67.6407322654462 69.7208237986270 71.1075514874142 69.7208237986270 67.8718535469107 63.9427917620137];
BW_1_dias = roipoly(img1_dias_S,x1d,y1d);

%[BW_2_dias,x2d,y2d] = roipoly(img1_dias_S);
x2d = [51.8089244851259 52.9645308924485 55.0446224256293 60.3604118993135 66.6006864988559 73.0720823798627 76.0766590389016 78.6189931350115 77.4633867276888 72.6098398169337 59.6670480549199 54.1201372997712 53.4267734553776 51.8089244851259];
y2d = [59.7826086956522 54.4668192219680 52.3867276887872 50.3066361556064 49.8443935926773 50.5377574370709 52.8489702517162 58.8581235697940 64.8672768878719 69.9519450800915 69.7208237986270 66.4851258581236 63.9427917620137 59.7826086956522];
BW_2_dias = roipoly(img1_dias_S,x2d,y2d);

%[BW_3_dias,x3d,y3d] = roipoly(img3_dias_S);
x3d = [53.6578947368421 55.0446224256293 58.2803203661328 64.7517162471396 70.7608695652174 74.6899313501145 76.5389016018307 77.2322654462243 75.6144164759726 70.9919908466819 64.5205949656751 58.7425629290618 55.0446224256293 53.8890160183067 53.6578947368421];
y3d = [55.8535469107551 51.2311212814645 49.3821510297483 47.9954233409611 48.6887871853547 52.6178489702517 56.7780320366133 62.3249427917620 66.9473684210526 70.1830663615561 70.1830663615561 68.5652173913043 63.9427917620137 60.4759725400458 55.8535469107551];
BW_3_dias = roipoly(img3_dias_S,x3d,y3d);

%[BW_4_dias,x4d,y4d] = roipoly(img4_dias_S);
x4d = [52.7334096109840 53.6578947368421 57.5869565217392 62.9027459954234 70.5297482837529 76.0766590389016 77.2322654462243 77.6945080091534 77.2322654462243 73.3032036613273 67.9874141876431 61.0537757437071 55.9691075514874 52.9645308924485 52.7334096109840];
y4d = [55.6224256292906 50.7688787185355 46.3775743707094 44.2974828375286 43.8352402745995 46.8398169336384 50.3066361556064 54.6979405034325 60.2448512585812 62.5560640732265 65.0983981693364 64.6361556064073 62.5560640732265 59.0892448512586 55.6224256292906];
BW_4_dias = roipoly(img4_dias_S,x4d,y4d);

%[BW_5_dias,x5d,y5d] = roipoly(img5_dias_S);
x5d = [49.7288329519451 51.3466819221968 53.4267734553776 55.7379862700229 58.9736842105264 62.4405034324943 67.2940503432495 69.6052631578948 72.1475972540046 72.6098398169337 71.4542334096110 69.8363844393593 67.5251716247140 65.2139588100687 59.8981693363845 55.2757437070938 52.9645308924485 51.5778032036614 49.9599542334096 49.2665903890160 49.0354691075515 49.7288329519451];
y5d = [51.4622425629291 47.9954233409611 46.3775743707094 45.9153318077803 45.9153318077803 47.5331807780320 49.3821510297483 51.9244851258581 54.4668192219680 57.7025171624714 60.4759725400458 63.7116704805492 66.4851258581236 67.8718535469107 68.1029748283753 67.8718535469107 66.2540045766590 64.1739130434783 60.0137299771167 57.9336384439359 53.3112128146453 51.4622425629291];
BW_5_dias = roipoly(img5_dias_S,x5d,y5d);


%% 
originalSize = [256 256]; % tamaño original DICOM

idx1 = 70;
idx2 = 170;

roipoly1_sys = PadToOriginal(BW_1_sys,  idx1, idx2, originalSize);
roipoly2_sys  = PadToOriginal(BW_2_sys,  idx1, idx2, originalSize);
roipoly3_sys  = PadToOriginal(BW_3_sys,  idx1, idx2, originalSize);
roipoly4_sys  = PadToOriginal(BW_4_sys,  idx1, idx2, originalSize);
roipoly5_sys  = PadToOriginal(BW_5_sys,  idx1, idx2, originalSize);
 
roipoly1_dias = PadToOriginal(BW_1_dias, idx1, idx2, originalSize);
roipoly2_dias = PadToOriginal(BW_2_dias, idx1, idx2, originalSize);
roipoly3_dias = PadToOriginal(BW_3_dias, idx1, idx2, originalSize);
roipoly4_dias = PadToOriginal(BW_4_dias, idx1, idx2, originalSize);
roipoly5_dias = PadToOriginal(BW_5_dias, idx1, idx2, originalSize);

figure;
subplot(2,5,1);
imagesc(roipoly1_sys); colormap('gray'); title('Vol Img1Sys Estimé');

subplot(2,5,2);
imagesc(roipoly2_sys); colormap('gray'); title('Vol Img2Sys Estimé');

subplot(2,5,3);
imagesc(roipoly3_sys); colormap('gray'); title('Vol Img3Sys Estimé');

subplot(2,5,4);
imagesc(roipoly4_sys); colormap('gray'); title('Vol Img4Sys Estimé');

subplot(2,5,5);
imagesc(roipoly5_sys); colormap('gray'); title('Vol Img5Sys Estimé');

subplot(2,5,6);
imagesc(roipoly1_dias); colormap('gray'); title('Vol Img1Dias Estimé');

subplot(2,5,7);
imagesc(roipoly2_dias); colormap('gray'); title('Vol Img2Dias Estimé');

subplot(2,5,8);
imagesc(roipoly3_dias); colormap('gray'); title('Vol Img3Dias Estimé');

subplot(2,5,9);
imagesc(roipoly4_dias); colormap('gray'); title('Vol Img4Dias Estimé');

subplot(2,5,10);
imagesc(roipoly5_dias); colormap('gray'); title('Vol Img5Dias Estimé');

%% Volumenes estimados
fprintf('Resultados usando segmentacion manual (roipoly) \n');
fprintf('Volumen estimado (estimada) IMG 1 Sys: %g\n', sum(roipoly1_sys(:)));
fprintf('Volumen estimado (estimada) IMG 2 Sys: %g\n', sum(roipoly2_sys(:)));
fprintf('Volumen estimado (estimada) IMG 3 Sys: %g\n', sum(roipoly3_sys(:)));
fprintf('Volumen estimado (estimada) IMG 4 Sys: %g\n', sum(roipoly4_sys(:)));
fprintf('Volumen estimado (estimada) IMG 5 Sys: %g\n', sum(roipoly5_sys(:)));
fprintf('Volumen estimado (estimada) IMG 1 Dias: %g\n', sum(roipoly1_dias(:)));
fprintf('Volumen estimado (estimada) IMG 2 Dias: %g\n', sum(roipoly2_dias(:)));
fprintf('Volumen estimado (estimada) IMG 3 Dias: %g\n', sum(roipoly3_dias(:)));
fprintf('Volumen estimado (estimada) IMG 4 Dias: %g\n', sum(roipoly4_dias(:)));
fprintf('Volumen estimado (estimada) IMG 5 Dias: %g\n', sum(roipoly5_dias(:)));


%% Fracción de eyección estimada
fprintf('Resultados usando segmentacion manual (roipoly) \n');
fprintf('Fraccion de eyeccion (estimada) IMG 1: %g\n', (sum(roipoly1_sys(:)) - sum(roipoly1_dias(:)))/sum(roipoly1_sys(:)));
fprintf('Fraccion de eyeccion (estimada) IMG 2: %g\n', (sum(roipoly2_sys(:)) - sum(roipoly2_dias(:)))/sum(roipoly1_sys(:)));
fprintf('Fraccion de eyeccion (estimada) IMG 3: %g\n', (sum(roipoly3_sys(:)) - sum(roipoly3_dias(:)))/sum(roipoly1_sys(:)));
fprintf('Fraccion de eyeccion (estimada) IMG 4: %g\n', (sum(roipoly4_sys(:)) - sum(roipoly4_dias(:)))/sum(roipoly1_sys(:)));
fprintf('Fraccion de eyeccion (estimada) IMG 5: %g\n', (sum(roipoly5_sys(:)) - sum(roipoly5_dias(:)))/sum(roipoly1_sys(:)));

